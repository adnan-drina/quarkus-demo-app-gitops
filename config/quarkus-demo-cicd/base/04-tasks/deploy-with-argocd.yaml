apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: deploy-with-argocd
spec:
  params:
    - name: environment
    - name: argo-app-name
    - name: configGitUrl
    - name: appImage
#    - name: buildRevision
  workspaces:
    - name: config-source

  steps:
#    - name: git-checkout
#      image: alpine/git:v2.26.2
#      workingDir: "$(workspaces.config-source.path)"
#      script: |
#        #!/usr/bin/env sh
#
#        git clone $(params.configGitUrl)

    - name: update-yaml
      image: alpine/git:v2.26.2
      workingDir: "$(workspaces.config-source.path)/$(inputs.params.environment)"
      script: |
        #!/usr/bin/env sh
        set -e

        echo "updating $(workspaces.config-source.path)/$(inputs.params.environment) image to $(inputs.params.appImage)"
        sed -i "s#quay.io/adrina/quarkus-demo-app:[a-zA-Z0-9]\\+#$(inputs.params.appImage)#" 100-deployment.yaml

#        echo "updating all pods in $(inputs.params.environment) to revision $(inputs.params.buildRevision)"
#        sed -i "s#revision: \"[a-zA-Z0-9]\\+\"#revision: \"$(inputs.params.buildRevision)\"#" app.yaml

    - name: commit-push-changes-gitops
      image: alpine/git:v2.26.2
      workingDir: "$(workspaces.config-source.path)/$(inputs.params.environment)"
      script: |
        #!/usr/bin/env sh
        set -e

#        git config --global user.email "tekton@tekton.dev"
#        git config --global user.name "Tekton Pipeline"
        git add .
        git commit --allow-empty -m "[tekton] updating image to $(inputs.params.appImage)"
#        eval $(ssh-agent)
#        ssh-add ~/.ssh/id_*
        git push origin master

    - name: wait-for-argocd-rollout
      image: argoproj/argocd:v1.7.7
      script: |
        #!/usr/bin/env sh
        set -e

        argocd app sync $(inputs.params.argo-app-name) --insecure -n argocd
        argocd app wait $(inputs.params.argo-app-name) --sync --health --operation --insecure -n argocd
---